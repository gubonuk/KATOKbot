import requests
import time
import json


def test_n8n_webhook(command, sender="í…ŒìŠ¤íŠ¸ì‚¬ìš©ì", room="í…ŒìŠ¤íŠ¸ë°©"):
    """
    n8n ì›¹í›…ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” í•¨ìˆ˜

    Args:
        command: ë³´ë‚¼ ëª…ë ¹ì–´ (ì˜ˆ: "ë†ì—…ê³µê³ ")
        sender: ë°œì‹ ì ì´ë¦„
        room: ë°© ì´ë¦„

    Returns:
        ì‘ë‹µ í…ìŠ¤íŠ¸ ë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€
    """
    n8n_url = "your_n8n_url"
    timestamp = int(time.time() * 1000)

    # ìš”ì²­ íŒŒë¼ë¯¸í„° êµ¬ì„±
    params = {
        "command": command,
        "sender": sender,
        "room": room,
        "timestamp": timestamp
    }

    print(f"ğŸ“¡ ìš”ì²­ URL: {n8n_url}")
    print(f"ğŸ“¡ ìš”ì²­ íŒŒë¼ë¯¸í„°: {params}")

    # ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„ (3ì´ˆ * 5 = 15ì´ˆ)
    max_attempts = 5
    attempt = 0
    waiting_message_shown = False

    while attempt < max_attempts:
        try:
            # 5ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            response = requests.get(n8n_url, params=params, timeout=5)

            # ì‘ë‹µ í™•ì¸
            if response.status_code == 200:
                print(f"âœ… ì‘ë‹µ ì½”ë“œ: {response.status_code}")
                response_text = response.text
                print(f"ğŸ“© ì‘ë‹µ ë°ì´í„° (ì²˜ìŒ 100ì): {response_text[:100]}")

                # JSON íŒŒì‹± ì‹œë„
                try:
                    parsed_response = parse_response(response_text)
                    print(f"âœ… íŒŒì‹± ì„±ê³µ: {type(parsed_response)}")

                    if isinstance(parsed_response, dict) and "response" in parsed_response:
                        print("\n=== ìµœì¢… ì‘ë‹µ ===")
                        print(parsed_response["response"])
                        print("================\n")
                        return parsed_response["response"]
                    else:
                        print("\n=== ìµœì¢… ì‘ë‹µ ===")
                        print(parsed_response)
                        print("================\n")
                        return str(parsed_response)

                except Exception as e:
                    print(f"âŒ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {e}")
                    print(f"ì›ë³¸ ì‘ë‹µ: {response_text}")
                    return f"ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: {e}"
            else:
                print(f"âŒ HTTP ì˜¤ë¥˜: {response.status_code}")
                print(f"ì‘ë‹µ ë‚´ìš©: {response.text}")

        except requests.exceptions.Timeout:
            print(f"â±ï¸ ìš”ì²­ {attempt + 1}ë²ˆì§¸ ì‹œë„ íƒ€ì„ì•„ì›ƒ")

        except requests.exceptions.RequestException as e:
            print(f"âŒ ìš”ì²­ {attempt + 1}ë²ˆì§¸ ì‹œë„ ì‹¤íŒ¨: {e}")

        # 6ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ëŒ€ê¸° ë©”ì‹œì§€ ì¶œë ¥
        if attempt == 1 and not waiting_message_shown:
            print("âŒ› ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...")
            waiting_message_shown = True

        attempt += 1
        if attempt < max_attempts:
            print(f"ğŸ”„ {3}ì´ˆ í›„ ì¬ì‹œë„... ({attempt}/{max_attempts})")
            time.sleep(3)

    return "âš  ì„œë²„ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."


def parse_response(text):
    """
    ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜

    Args:
        text: ì‘ë‹µ í…ìŠ¤íŠ¸

    Returns:
        íŒŒì‹±ëœ JSON ë˜ëŠ” í…ìŠ¤íŠ¸
    """
    if not text:
        print("âŒ ë¹ˆ ì‘ë‹µ ë°ì´í„°")
        return {"response": "ì„œë²„ì—ì„œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤."}

    cleaned_text = text.strip()

    # ì‘ë‹µì´ HTMLë¡œ ê°ì‹¸ì ¸ ìˆëŠ” ê²½ìš° ì¶”ì¶œ ì‹œë„
    import re
    body_match = re.search(r'<body.*?>([\s\S]*?)<\/body>', cleaned_text, re.IGNORECASE)
    if body_match:
        cleaned_text = body_match.group(1).strip()
        print("ğŸ” <body> íƒœê·¸ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ")

    # HTML íƒœê·¸ ì œê±°
    if cleaned_text.startswith("<") and cleaned_text.endswith(">"):
        cleaned_text = re.sub(r'<[^>]*>', '', cleaned_text).strip()
        print("ğŸ” HTML íƒœê·¸ ì œê±° ì™„ë£Œ")

    # ì¼ë°˜ í…ìŠ¤íŠ¸ì¸ ê²½ìš° JSON ê°ì²´ë¡œ ë³€í™˜
    if not cleaned_text.startswith("{") and not cleaned_text.startswith("["):
        print("ğŸ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ ë³€í™˜")
        return {"response": cleaned_text}

    # ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ ë³€í™˜
    if "'" in cleaned_text and '"' not in cleaned_text:
        cleaned_text = cleaned_text.replace("'", '"')
        print("ğŸ” ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ ë³€í™˜")

    # JSON íŒŒì‹± ì‹œë„
    try:
        return json.loads(cleaned_text)
    except json.JSONDecodeError as e:
        print(f"ğŸ” ì²« ë²ˆì§¸ JSON íŒŒì‹± ì‹¤íŒ¨: {e}")

        # ì†ì„±ëª…ì— ë”°ì˜´í‘œ ì¶”ê°€ ì‹œë„
        try:
            # ì†ì„±ëª…ì— ë”°ì˜´í‘œ ì¶”ê°€
            import re
            cleaned_text = re.sub(r'([\'"])?([a-zA-Z0-9_]+)([\'"])?:', r'"\2":', cleaned_text)
            print("ğŸ” ì†ì„±ëª…ì— ë”°ì˜´í‘œ ì¶”ê°€ ì‹œë„")
            return json.loads(cleaned_text)
        except json.JSONDecodeError:
            # ìµœì¢…ì ìœ¼ë¡œ ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
            print("âŒ ìµœì¢… JSON íŒŒì‹± ì‹¤íŒ¨")
            return {"response": text.strip()}


if __name__ == "__main__":
    while True:
        print("\n=== n8n ì›¹í›… í…ŒìŠ¤í„° ===")
        command = input("ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì¢…ë£Œí•˜ë ¤ë©´ 'q' ì…ë ¥): ")

        if command.lower() == 'q':
            print("í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break

        if not command:
            print("ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
            continue

        print(f"\n'{command}' ëª…ë ¹ ì‹¤í–‰ ì¤‘...\n")
        result = test_n8n_webhook(command)

        print("\nê³„ì†í•˜ë ¤ë©´ Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”...")
        input()
