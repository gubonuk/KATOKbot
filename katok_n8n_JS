const API_KEY = "your_api";

function sendToN8n(command, sender, room, replier) {
    try {
        let n8nBaseUrl = "your_n8n";
        let timestamp = new Date().getTime();
        let queryUrl = n8nBaseUrl + 
                      "?command=" + encodeURIComponent(command) + 
                      "&sender=" + encodeURIComponent(sender) + 
                      "&room=" + encodeURIComponent(room) + 
                      "&timestamp=" + timestamp;
        
        Log.d("ğŸ“¡ n8n ìš”ì²­ URL: " + queryUrl);
        
        let responseText = "";
        let maxAttempts = 5; // ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„ (3ì´ˆ * 5 = 15ì´ˆ)
        let attempt = 0;
        let isWaitingMessageSent = false;

        while (attempt < maxAttempts) {
            try {
                // íƒ€ì„ì•„ì›ƒì´ ìˆëŠ” ìš”ì²­ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸°ì¡´ Utils.getWebText ì‚¬ìš©
                responseText = getWebTextWithTimeout(queryUrl, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                // ë˜ëŠ” ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©: responseText = Utils.getWebText(queryUrl);
                
                if (responseText) {
                    break; // ì‘ë‹µì´ ë„ì°©í•˜ë©´ ë°”ë¡œ ì¢…ë£Œ
                }
            } catch (requestError) {
                Log.e("ğŸ“¡ ìš”ì²­ ì‹œë„ " + (attempt + 1) + " ì‹¤íŒ¨: " + requestError);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì¬ì‹œë„ ê³„ì†
            }

            // 6ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”" ë©”ì‹œì§€ ì¶œë ¥
            if (attempt == 2 && !isWaitingMessageSent) {
                replier.reply("âŒ› ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...");
                isWaitingMessageSent = true;
            }

            java.lang.Thread.sleep(3000); // 3ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„
            attempt++;
        }

        if (!responseText) {
            Log.e("âŒ n8n ì‘ë‹µ ì—†ìŒ (ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨)");
            return "âš  ì„œë²„ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }

        Log.d("ğŸ“© n8n ì‘ë‹µ ë°ì´í„°: " + responseText);
        
        // JSONì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±
        let jsonResponse = safeParseJSON(responseText);

        if (jsonResponse && jsonResponse.response) {
            return jsonResponse.response;
        } else {
            Log.d("âš  ì‘ë‹µ í˜•ì‹ ë¬¸ì œ: " + JSON.stringify(jsonResponse));
            return "âš  ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
    } catch (e) {
        Log.e("âŒ n8n í†µì‹  ì˜¤ë¥˜: " + e);
        return "âŒ ì„œë²„ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || e);
    }
}

// íƒ€ì„ì•„ì›ƒì´ ìˆëŠ” ì›¹ ìš”ì²­ í•¨ìˆ˜
function getWebTextWithTimeout(url, timeout) {
    try {
        // Java URL ê°ì²´ ìƒì„±
        let urlObj = new java.net.URL(url);
        
        // URLConnection ê°ì²´ ìƒì„± ë° íƒ€ì„ì•„ì›ƒ ì„¤ì •
        let connection = urlObj.openConnection();
        connection.setConnectTimeout(timeout);
        connection.setReadTimeout(timeout);
        connection.setRequestProperty("User-Agent", "KakaoTalkBot/1.0");
        
        // ì‘ë‹µ ì½”ë“œ í™•ì¸
        let responseCode = connection.getResponseCode();
        if (responseCode != 200) {
            Log.e("âŒ HTTP ì˜¤ë¥˜ ì‘ë‹µ: " + responseCode);
            return null;
        }
        
        // ì‘ë‹µ ì½ê¸°
        let inputStream = new java.io.BufferedReader(
            new java.io.InputStreamReader(connection.getInputStream())
        );
        let response = new java.lang.StringBuilder();
        let line;
        
        while ((line = inputStream.readLine()) != null) {
            response.append(line).append("\n");
        }
        
        inputStream.close();
        return response.toString();
    } catch (e) {
        if (e.toString().includes("SocketTimeoutException")) {
            Log.e("â±ï¸ ì†Œì¼“ íƒ€ì„ì•„ì›ƒ ë°œìƒ: " + e.message);
            throw new Error("ìš”ì²­ ì‹œê°„ ì´ˆê³¼");
        } else {
            Log.e("âŒ ì›¹ ìš”ì²­ ì˜¤ë¥˜: " + e);
            throw e;
        }
    }
}

function safeParseJSON(text) {
    try {
        if (!text) {
            Log.e("âŒ ë¹ˆ ì‘ë‹µ ë°ì´í„°");
            return { response: "ì„œë²„ì—ì„œ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤." };
        }
        
        let cleanedText = text.trim();
        
        // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
        Log.d("ğŸ” JSON íŒŒì‹± ì‹œì‘ - ì›ë³¸ í…ìŠ¤íŠ¸ ê¸¸ì´: " + cleanedText.length);
        Log.d("ğŸ” JSON íŒŒì‹± ì‹œì‘ - ì²˜ìŒ 100ì: " + cleanedText.substring(0, Math.min(100, cleanedText.length)));
        
        // ì‘ë‹µì´ HTMLë¡œ ê°ì‹¸ì ¸ ìˆëŠ” ê²½ìš°, <body> ë‚´ë¶€ë§Œ ì¶”ì¶œ
        let match = cleanedText.match(/<body.*?>([\s\S]*?)<\/body>/i);
        if (match) {
            cleanedText = match[1].trim();
            Log.d("ğŸ” <body> íƒœê·¸ì—ì„œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸: " + cleanedText.substring(0, Math.min(100, cleanedText.length)));
        }
        
        // JSON ê°ì²´ì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì²« ê¸€ìì™€ ë§ˆì§€ë§‰ ê¸€ì ê²€ì‚¬
        cleanedText = cleanedText.trim();
        if (cleanedText.startsWith("<") && cleanedText.endsWith(">")) {
            // HTML íƒœê·¸ê°€ ë‚¨ì•„ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ ë‚´ìš©ë§Œ ì¶”ì¶œ ì‹œë„
            cleanedText = cleanedText.replace(/<[^>]*>/g, "").trim();
            Log.d("ğŸ” HTML íƒœê·¸ ì œê±° í›„: " + cleanedText.substring(0, Math.min(100, cleanedText.length)));
        }
        
        // ì‘ë‹µì´ ì¼ë°˜ í…ìŠ¤íŠ¸ì¸ ê²½ìš° JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        if (!cleanedText.startsWith("{") && !cleanedText.startsWith("[")) {
            Log.d("ğŸ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ ë³€í™˜ ì‹œë„");
            return { response: cleanedText };
        }
        
        // ë”°ì˜´í‘œ ë¬¸ì œ ìˆ˜ì • (ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ ë³€í™˜)
        if (cleanedText.includes("'") && !cleanedText.includes('"')) {
            cleanedText = cleanedText.replace(/'/g, '"');
            Log.d("ğŸ” ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ ë³€í™˜");
        }
        
        // ì—¬ëŸ¬ ë²ˆì˜ JSON.parse ì‹œë„
        try {
            return JSON.parse(cleanedText);
        } catch (parseError) {
            Log.d("ğŸ” ì²« ë²ˆì§¸ JSON.parse ì‹¤íŒ¨: " + parseError);
            
            // ì‰¼í‘œë‚˜ ë”°ì˜´í‘œ ë¬¸ì œ ì²˜ë¦¬
            if (cleanedText.includes("\"")) {
                cleanedText = cleanedText.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                Log.d("ğŸ” ì†ì„±ëª…ì— ë”°ì˜´í‘œ ì¶”ê°€ ì‹œë„");
            }
            
            try {
                return JSON.parse(cleanedText);
            } catch (finalError) {
                // ë§ˆì§€ë§‰ ì‹œë„: í…ìŠ¤íŠ¸ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬
                Log.e("âŒ ìµœì¢… JSON íŒŒì‹± ì‹¤íŒ¨: " + finalError);
                return { response: text.trim() };
            }
        }
    } catch (e) {
        Log.e("âŒ JSON íŒŒì‹± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + e + "\nì›ë³¸ ì‘ë‹µ ì¼ë¶€: " + text.substring(0, Math.min(200, text.length)));
        return { response: "ì„œë²„ ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”." };
    }
}

function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {
    Log.d("ğŸ“¥ ì‚¬ìš©ì ì…ë ¥: " + msg);

    if (msg.indexOf("ì„¸ë¹„ìŠ¤ ") === 0 || msg == "ì„¸ë¹„ìŠ¤") {
        let command = msg.replace("ì„¸ë¹„ìŠ¤", "").trim();
        if (!command) {
            replier.reply("ì„¸ë¹„ìŠ¤ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: ì„¸ë¹„ìŠ¤ ë†ì—…ê³µê³ ");
            return;
        }

        let n8nResponse = sendToN8n(command, sender, room, replier);

        Log.d("ğŸ“¤ ìµœì¢… ì‘ë‹µ ë°ì´í„°: " + n8nResponse);

        if (n8nResponse) {
            replier.reply(n8nResponse);
        } else {
            replier.reply("âš  ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }
}
